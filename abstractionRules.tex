\section{Physiological Abstraction rules}
\label{abstractionRules}
%In the last section we presented a formal model of the human heart as a labeled graph, where each vertex and edge are labeled by a timed automaton.
%A given choice of graph structure and of invariant and guard parameters for the automata results in a model that exhibits a given physiological condition, like atrial fibrillation, atrial flutter, etc.
%Because a pacemaker is meant to control and improve a range of physiological conditions, there is a need to verify it in a closed loop with all corresponding models.
%However this is not possible in practice, since any set of models we explicitly generate will necessarily be incomplete. 
In this section, we present domain-specific abstraction rules that can introduce new behaviors to a given model. 
These new behaviors are physiologically meaningful and might be manifested by a heart condition not explicitly modeled in the initial set of models.
The physician (or domain expert) remains the ultimate arbiter of what is physiologically meaningful.
Due to space limit we only introduce a subset of abstraction rules. 
The full set is in the technical report \cite{regar_tech}.

We introduce some notation: given a graph $G$ and an element $x \in V(G) \cup E(G)$ of $G$, we write $A_x$ for the automaton labeling that element.
We write $\Ac(G)$ for the set of automata of a graph: $\Ac(G) = \{A_x : x \in V(G) \cup E(G)\}$.
The set of parameters of the automaton is written $\Pc(A_x) = \{\theta_1^x,\theta_2^x,\ldots\}$. 
Recall that a parameter $\theta$ has both a minimum $\theta_{min}$ (which is used in the guard definitions of the automaton) and a maximum $\theta_{max}$ (which is used in the invariant definition of the automaton).

%\input{rule1}
%\input{rule2}

\subsection{Rule 4: Merge Parameter Ranges}
\textbf{Physiological intuition}. 
Timing periods of heart tissue is modeled as locations in the node and path automata. The minimum and maximum time an automaton can stay in the location is governed by the parameters in the guards and invariants. By combining parameter ranges for two automata with same structure the new automaton covers the behaviors of both automata.
%By expanding these periods, we introduce new behavior where a heart may stay in rest for longer, or (self-)activate a node faster, or tissue can conduct current sooner, etc.

\textbf{(Sub)graph(s) to which it applies}.
This rule applies to a set of graphs $G_i$ with the same structure (i.e. isomorphic) but possibly with different parameters: $R(G_1,\ldots,G_n) = G'$.
See Fig.~\ref{fig:HM_abs}.

\textbf{Applicability conditions}.
None.

\textbf{Output (sub)graph $G'$}.
$G'$ has same structure as the $G_i$.
Thus $R$ plays the role of an isomorphism between every $G_i$ and $G'$.
Given an element $x$ of $G'$, we abuse notation by writing $R^{-1}(x') = \{x_1,\dots,x_n\}$ is the set of elements that map to it via $R$.

\textbf{Effect on parameters}
%Recall Def.~\ref{def:labeledGraph}
For every automaton $A_{x'} \in \Ac(G')$, and every parameter $\theta^{x'}$ of $A_{x'}$, 
\[\theta_{min}^{x'} = \min(\theta^x_{min})_{x \in R^{-1}(x') }\]
\[\theta_{max}^{x'} = \max(\theta^x_{max})_{x \in R^{-1}(x') }\]

\textbf{Proof of abstraction} Detailed proof can be found in \cite{regar_tech}.

%\input{rule5}

\subsection{Rule 6: Replace Blocking With Non-deterministic Conduction}
\textbf{Physiological intuition}. 
Consider the structure $N_1 P_1 N_2 P_2 N_3$ with three nodes and two paths, where $N_2$ is a passive node (i.e. not self-activating).
If $N_2$ blocks an activation signal from $N_1$ to $N_3$, this is equivalent to the paths $P_1$ or $P_2$ not conducting.
In this rule, we replace the structure $P_1 N_2 P_2$ by a path $P$ whose automaton can take a self loop when it receives an activation signal, thus effectively stopping the conduction. 
This is shown in Fig.~\ref{fig:rule5}: the extra transitions are marked {\quattrofont Act\_path\_1?} and {\quattrofont Act\_path\_2?}.
Because the blocking effect of nodes is now incorporated into the paths, we can also modify the node automata of self-activating nodes to the one shown in Fig.~\ref{fig:rule5}, which doesn't have the (now useless) ERP period.

\textbf{Subgraph to which it applies}.
Line graphs with 3 vertices $N_1 P_1 N_2 P_2 N_3$, and self-activating nodes.

\textbf{Applicability conditions}.
$N_2$ is a passive node.

\textbf{Output subgraph}.
$N'_1 P' N'_3$
A path $P$ whose path automaton is as shown in Fig.~\ref{fig:rule5}.
The self-activating nodes $N$ are replaced by nodes $N'$ with automata shown in Fig.~\ref{fig:rule5}.

\textbf{Effect on parameters}
For the new path, $P.cond_{min}=P_1.cond_{min}+P_2.cond_{min}$ and 
$P.cond_{max}=P_1.cond_{max}+P_2.cond_{max}$
For the new nodes, $N'.Trest_{min}=N.TERP_{min}+N.Trest_{min}$ and 
$N'.Trest_{max}=N.TERP_{max}+N.Trest_{max}$.


\textbf{Proof of abstraction} Timed simulation relationship between $N_1 P_1 N_2 P_2 N_3$ and $N'_1 P' N'_3$ are proved in \cite{sttt13}.

\begin{figure}[!h]
	\centering
	\includegraphics[width=0.9\textwidth]{figs/rule5.pdf}
	%\vspace{-5pt}
	\caption{\small Automata of Rule 5}
	%\vspace{-15pt}
	\label{fig:rule5}
\end{figure}

\subsection{Rule 7: Replace Conductions With Self-activation}
\textbf{Physiological intuition}. 
This rule applies only after Rule 5 has been applied, and sensing nodes have been merged with self-activation nodes.

The effect of a conduction path is to conduct electrical activity generated by a self-activation node to other nodes. 
If we simply allow all self-activation nodes to activate at any time by setting their Rest period to $+\infty$, we can remove all the conduction paths, while preserving the original behavior (where the Rest period was constrained to a finite interval).

\textbf{Subgraph to which it applies}.
The entire graph $G$.

\textbf{Applicability conditions}.
This rule can only be applied after Rule 5 has been applied.

\textbf{Output subraph}.
All edges are deleted: $G' = (V(G), \emptyset)$.

\textbf{Effect on parameters}
For every node automaton $N$ in $G'$, $N.Trest = +\infty$.

\textbf{Proof of abstraction}.

\begin{figure}[!h]
	\centering
	\includegraphics[width=0.3\textwidth]{figs/rule6.pdf}
	%\vspace{-5pt}
	\caption{\small Heart Model Abstractions}
	%\vspace{-15pt}
	\label{fig:rule6}
\end{figure}

\subsection{Heart Model Abstraction Tree}
We first develop a list of heart models corresponding to common heart conditions. The list can be expanded as new heart conditions are discovered.
By systematically applying rules in this section we created an abstraction tree $HM\_tree$ for the heart (\figref{HM_abs}). 
%Note that applying rules in different order results different abstraction tree. 
%The order used to obtain $HM\_tree$ is based on the domain knowledge that certain heart conditions may have similar behaviors and similar inputs to the pacemaker. 
%This systematic grouping maintains the physiological-relevance of the heart model even at higher abstraction levels, and reduce the necessity to resolve ambiguities at lower abstraction levels when model checking certain requirements.
\begin{figure}[!t]
	\centering
	\includegraphics[width=0.9\textwidth]{figs/abs.pdf}
	%\vspace{-5pt}
	\caption{\small Heart Model Abstractions}
	%\vspace{-15pt}
	\label{fig:HM_abs}
\end{figure}

\begin{figure}[!t]
	\centering
	\includegraphics[width=0.5\textwidth]{figs/abs_sim.pdf}
	%\vspace{-5pt}
	\caption{\small Abstraction Example}
	%\vspace{-15pt}
	\label{fig:abs_exam}
\end{figure}
%\subsection{Rule Application Example}
%In this section we demonstrate 
%\todo[inline]{I don't understand what this is...}
%$$NA\_self=\{SA\_self,AVNRT\_self,AF\_self,PAC\_self\}$$
%$$NV\_self=\{PVC\_self,VF\_self,VT\_self\}$$
%$$(NA,AV')\_cond=\{(SA,AV)\_cond\}$$
%$$(AV',NV)\_cond=\{(AV,RBB)\_cond,RBB-RVA\_cond\}$$
%Apply Rule 6:
%$$NA'\_self=\{NA\_self\}$$
%$$NV'\_self=\{NV\_self\}$$
%$$(NA',NV')\_cond=\{AV'\_block,(NA,AV')\_cond,(AV',NV)\_cond\}$$
%Apply Rule 7:
%$$NA''\_self=\{NA'\_self,(NA',NV')\_cond\}$$
%$$NV''\_self=\{NV'\_self,(NA',NV')\_cond\}$$
%\begin{figure}[!t]
%\centering
%\includegraphics[width=0.9\textwidth]{figs/abs.png}
%%\vspace{-5pt}
%\caption{\small Heart Model Abstractions}
%%\vspace{-15pt}
%\label{fig:abs_exam}
%\end{figure}
